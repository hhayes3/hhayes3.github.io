import plotly.graph_objects as go
import urllib, json
import pandas as pd
import plotly
import numpy as np

df = pd.read_csv("https://raw.githubusercontent.com/smart-stats/ds4bio_book/main/book/assetts/kirby21AllLevels.csv")
df = df.drop(['Unnamed: 0', 'min', 'max', 'std'], 
             axis = 1)
df = df.loc[(df.rawid == "kirby142a_3_1_ax.img")]

url = "https://raw.githubusercontent.com/bcaffo/MRIcloudT1volumetrics/master/inst/extdata/multilevel_lookup_table.txt"
lookup = pd.read_csv(url, sep = "\t").drop(['Level5'], axis = 1)
lookup = lookup.rename(columns = {
    "modify"   : "roi", 
    "modify.1" : "lev_4",
    "modify.2" : "lev_3", 
    "modify.3" : "lev_2",
    "modify.4" : "lev_1"})
lookup = lookup[['roi', 'lev_4', 'lev_3', 'lev_2', 'lev_1']]

id = 142
df = pd.read_csv("https://raw.githubusercontent.com/smart-stats/ds4bio_book/main/book/assetts/kirby21AllLevels.csv")
df = df.loc[(df.type == 1) & (df.level == 5) & (df.id == id)]
df = df[['roi', 'volume']]
df = pd.merge(df, lookup, on = "roi")
df = df.assign(icv = "ICV")
df = df.assign(comp = df.volume / np.sum(df.volume))

def genSankey(df,cat_cols = [],value_cols = '', title = 'Sankey Diagram'):
    colorPalette = ['#4B8BBE','#306998','#FFE873','#FFD43B','#646464']
    labelList = []
    colorNumList = []
    for catCol in cat_cols:
        labelListTemp =  list(set(df[catCol].values))
        colorNumList.append(len(labelListTemp))
        labelList = labelList + labelListTemp
        
    labelList = list(dict.fromkeys(labelList))
    
    colorList = []
    for idx, colorNum in enumerate(colorNumList):
        colorList = colorList + [colorPalette[idx]]*colorNum
        
    for i in range(len(cat_cols)-1):
        if i == 0:
            sourceTargetDf = df[[cat_cols[i],cat_cols[i+1],value_cols]]
            sourceTargetDf.columns = ['source','target','count']
        else:
            tempDf = df[[cat_cols[i],cat_cols[i+1],value_cols]]
            tempDf.columns = ['source','target','count']
            sourceTargetDf = pd.concat([sourceTargetDf,tempDf])
        sourceTargetDf = sourceTargetDf.groupby(['source','target']).agg({'count':'sum'}).reset_index()
        
    sourceTargetDf['sourceID'] = sourceTargetDf['source'].apply(lambda x: labelList.index(x))
    sourceTargetDf['targetID'] = sourceTargetDf['target'].apply(lambda x: labelList.index(x))
    
    data = dict(
        type ='sankey',
        node = dict(
          pad = 15,
          thickness = 20,
          line = dict(
            color = "black",
            width = 0.5
          ),
          label = labelList,
          color = colorList
        ),
        link = dict(
          source = sourceTargetDf['sourceID'],
          target = sourceTargetDf['targetID'],
          value = sourceTargetDf['count']
        )
      )
    
    layout =  dict(
        title = title,
        font = dict(
          size = 10
        )
    )
       
    fig = dict(data = [data], layout = layout)
    return fig

fig = genSankey(df,cat_cols = ['icv', 'lev_1', 'lev_2', 'lev_3', 'lev_4'], value_cols = 'comp', title = 'Subject 142 Brain Comp')
plotly.offline.plot(fig, validate=False)
